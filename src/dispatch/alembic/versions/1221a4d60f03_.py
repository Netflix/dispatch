"""Adds discoverable column

Revision ID: 1221a4d60f03
Revises: 14d7a4703d7c
Create Date: 2020-04-17 15:25:36.075381

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.orm import Session
from dispatch.tag.models import Tag

import sqlalchemy_utils


# revision identifiers, used by Alembic.
revision = "1221a4d60f03"
down_revision = "14d7a4703d7c"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("incident_priority", sa.Column("page_commander", sa.Boolean(), nullable=True))
    op.add_column(
        "incident_priority",
        sa.Column("search_vector", sqlalchemy_utils.types.ts_vector.TSVectorType(), nullable=True),
    )
    op.add_column("incident_priority", sa.Column("status_reminder", sa.Integer(), nullable=True))
    op.add_column("incident_priority", sa.Column("view_order", sa.Integer(), nullable=True))
    op.create_index(
        "ix_incident_priority_search_vector",
        "incident_priority",
        ["search_vector"],
        unique=False,
        postgresql_using="gin",
    )
    op.add_column("tag", sa.Column("discoverable", sa.Boolean()))

    conn = op.get_bind()
    session = Session(bind=conn)

    for tag in session.query(Tag).all():
        tag.discoverable = True
    session.commit()
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("tag", "discoverable")
    op.drop_index("ix_incident_priority_search_vector", table_name="incident_priority")
    op.drop_column("incident_priority", "view_order")
    op.drop_column("incident_priority", "status_reminder")
    op.drop_column("incident_priority", "search_vector")
    op.drop_column("incident_priority", "page_commander")
    # ### end Alembic commands ###
