"""Adds the ability for case to send and interact with external conversations.

Revision ID: 6e53722fa1f2
Revises: bd61c1e1e7cd
Create Date: 2023-01-13 14:37:42.899102

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "6e53722fa1f2"
down_revision = "bd61c1e1e7cd"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "assoc_signal_tags",
        sa.Column("signal_id", sa.Integer(), nullable=False),
        sa.Column("tag_id", sa.Integer(), nullable=False),
        sa.ForeignKeyConstraint(["signal_id"], ["signal.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(["tag_id"], ["tag.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("signal_id", "tag_id"),
    )
    op.add_column("case_type", sa.Column("conversation_target", sa.String(), nullable=True))
    op.add_column("conversation", sa.Column("thread_id", sa.String(), nullable=True))
    op.add_column("conversation", sa.Column("case_id", sa.Integer(), nullable=True))
    op.create_foreign_key(None, "conversation", "case", ["case_id"], ["id"], ondelete="CASCADE")
    op.add_column("signal", sa.Column("loopin_signal_identity", sa.Boolean(), nullable=True))
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("signal", "loopin_signal_identity")
    op.add_column(
        "search_filter", sa.Column("type", sa.VARCHAR(), autoincrement=False, nullable=True)
    )
    op.add_column(
        "plugin_instance",
        sa.Column(
            "configuration",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_column("notification", "subject")
    op.drop_constraint(None, "conversation", type_="foreignkey")
    op.drop_column("conversation", "case_id")
    op.drop_column("conversation", "thread_id")
    op.drop_column("case_type", "conversation_target")
    op.drop_table("assoc_signal_tags")
    # ### end Alembic commands ###
